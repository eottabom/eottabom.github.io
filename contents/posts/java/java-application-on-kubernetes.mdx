---
title: "Java Application on kubernetes"
date: "2024-05-22"
tags: ["Java", "kubernetes"]
updated: "2025-09-02"
summary: "Practical JVM and container tuning tips: memory sizing, CPU settings, probes, and GC choices tailored for K8s."
description: "ì»¨í…Œì´ë„ˆ/Kubernetes í™˜ê²½ì—ì„œ Java ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì•ˆì •ì ìœ¼ë¡œ ìš´ì˜í•˜ê¸° ìœ„í•œ ë©”ëª¨ë¦¬/CPU ì„¤ì •, í”„ë¡œë¸Œ, GC, QoS ì „ëµ ì •ë¦¬"
---

:::info
kubernetes í™˜ê²½ì—ì„œ Java ì–´í”Œë¦¬ì¼€ì´ì…˜ì˜ ë¦¬ì†ŒìŠ¤(CPU, Memory)ëŠ” <b>ì‹¤ì œ ì§€í‘œ ê¸°ë°˜</b> ìœ¼ë¡œ ì¡°ì •í•˜ëŠ” ê²ƒì´ ê°€ì¥ ë°”ëŒì§í•˜ë‹¤.
í•˜ì§€ë§Œ, ì‹ ê·œ ì„œë¹„ìŠ¤ë‚˜ ì•„ì§ ì§€í‘œê°€ ì¶©ë¶„í•˜ì§€ ì•Šì€ ê²½ìš°ë¥¼ ìœ„í•´, ê° best practice ë¥¼ ì°¾ì•„ë³´ì•˜ê³ , ì•ˆì •ì ì¸ ì´ˆê¸° ì„¤ì • ê°€ì´ë“œë¥¼ ì •ë¦¬í•´ë³´ì•˜ë‹¤.
:::


---

## Best Practices: Java Memory Arguments for Containers

:::quote
[Best Practices : Java Memory Arguments for Containers](https://dzone.com/articles/best-practices-java-memory-arguments-for-container) ì— ëŒ€í•œ ë‚´ìš©
:::

### ëª¨ë²” ì‚¬ë¡€ 1

* í™ í¬ê¸° êµ¬ì„±ì— ì‚¬ìš©í•˜ëŠ” ì˜µì…˜ (`-XX: MaxRAMFraction`, `-XX: MaxRAMPercentage`, `-Xmx`) ì— ê´€ê³„ ì—†ì´ í•­ìƒ ì»¨í…Œì´ë„ˆì— <RedText>ìµœì†Œ 25%</RedText> ë” ë§ì€ ë©”ëª¨ë¦¬ë¥¼ í• ë‹¹í•œë‹¤.
* Java Thread, Garbage Collection, Metaspace, Native Memory, Socket buffers ë¥¼ ìœ„í•œ ê³µê°„ì´ í•„ìš”í•˜ë‹¤.
  * ex) MaxRAMPercentage: 75


### ëª¨ë²” ì‚¬ë¡€ 2

* ì´ˆê¸° í™ í¬ê¸°(`-XX:InitialRAMFraction`, `-XX:InitialRAMPercentage`, `-Xms`) ë¥¼ ìµœëŒ€ í™ í¬ê¸°(`-XX: MaxRAMFraction`, `-XX: MaxRAMPercentage`, `-Xmx`) ì™€ ë™ì¼í•œ í¬ê¸°ë¡œ ì„¤ì •í•œë‹¤.

:::note
<b>ì´ˆê¸° í™ í¬ê¸° = ìµœëŒ€ í™ í¬ê¸° ì„¤ì •ì‹œ ì¥ì </b>
[Benefits of setting initial and maximum memory size to the same value](https://blog.ycrash.io/benefits-of-setting-initial-and-maximum-memory-size-to-the-same-value/)
âœ” í™ í¬ê¸°ê°€ ì´ˆê¸° í• ë‹¹ í¬ê¸°ë³´ë‹¤ ì»¤ì§ˆ ë•Œë§ˆë‹¤ JVM ì´ ì¼ì‹œ ì¤‘ì§€ ë˜ì–´ì„œ, `ì´ˆê¸° í™ í¬ê¸° = ìµœëŒ€ í™ í¬ê¸°` ë¡œ ì„¤ì •í•˜ë©´ Garbage Collection pause time ì´ ë‚®ì•„ì§„ë‹¤.
:::


### ëª¨ë²” ì‚¬ë¡€ 3

* `XX: MaxRAMFraction`, `XX:MaxRAMPercentage` ë³´ë‹¤ëŠ” `Xmx` ì˜µì…˜ì„ ì‚¬ìš©í•´ì„œ ì„¸ë°€í•˜ê³  ì •ë°€í•œ ê°’ì„ ì„¤ì •í•´ë¼.
* Container ì˜ ë©”ëª¨ë¦¬ ì„¤ì •ì— ë”°ë¼ ì¡°ì •ë˜ëŠ” ê²ƒë³´ë‹¤ëŠ” ì„¸ë°€í•˜ê³  ì •ë°€í•œ ê°’ì„ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.


---

## Best Practices for Java Apps on Kubernetes

:::quote
[Best Practices for Java Apps on Kubernetes](https://piotrminkowski.com/2023/02/13/best-practices-for-java-apps-on-kubernetes/) ì¼ë¶€ ë‚´ìš©
:::

### 1. Don't Set Limits Too Low

* CPU, Memory ì˜ Limit ì„ ë„ˆë¬´ ë‚®ê²Œ ì„¤ì •í•˜ì§€ ë§ˆë¼.
* Java ëŠ” ì¼ë°˜ì ì¸ ì‘ì—…ì—ì„œ ë§ì€ CPU ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šë”ë¼ë„, ë¹ ë¥´ê²Œ ì‹œì‘í•˜ë ¤ë©´ ë§ì€ CPU ê°€ í•„ìš”í•˜ë‹¤.

:::note
CPU ì œí•œ ì„¤ì •ì„ ê¶Œí•œí•˜ì§€ ì•ŠëŠ” ê¸€ : https://home.robusta.dev/blog/stop-using-cpu-limits
í•´ë‹¹ ê¸€ì— ëŒ€í•œ ë°˜ë°• ê¸€ : https://dnastacio.medium.com/why-you-should-keep-using-cpu-limits-on-kubernetes-60c4e50dfc61
âœ” ê²°ë¡ ì ìœ¼ë¡œëŠ” CPU, Memory Limit ì„ ì„¤ì •í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤ëŠ” ë‚´ìš©
:::


### 2. Consider Memory Usage First

* kubernetes ì—ì„œ ì•±ì„ ì‹¤í–‰í•˜ê¸° ì „ì— ìµœì†Œí•œ ì˜ˆìƒ ë¡œë“œì—ì„œ ì•±ì´ ì†Œë¹„í•˜ëŠ” ë©”ëª¨ë¦¬ ëŸ‰ì„ ì¸¡ì • í•´ì•¼í•œë‹¤.

```shell
Heap = Total Container Memory - Non heap - Headroom

Non Heap = Direct Memory + Metaspace + Reserved Code Cache + (Thread Stack * Thread Count)
```

### 3. Proper Liveness and Readiness Probes

* `LivenessProbe` ì™€ `ReadinessProbe` ë¥¼ ì„¤ì •í•´ë¼.
* `LivenessProbe` ëŠ” ì»¨í…Œì´ë„ˆë¥¼ ë‹¤ì‹œ ì‹œì‘í• ì§€ ì—¬ë¶€ë¥¼ ê²°ì •í•˜ëŠ”ë° ì‚¬ìš©ë˜ê³ , ì–´ë–¤ ì´ìœ ë¡œë“  Application ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” ê²½ìš° ì»¨í…Œì´ë„ˆë¥¼ ë‹¤ì‹œ ì‹œì‘í•˜ëŠ” ê²ƒì´ í•©ë¦¬ì ì¼ ìˆ˜ ìˆë‹¤.
* `ReadinessProbe` ëŠ” ì»¨í…Œì´ë„ˆê°€ ë“¤ì–´ì˜¤ëŠ” íŠ¸ë˜í”½ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ”ì§€ ê²°ì •í•˜ëŠ”ë° ì‚¬ìš©ë˜ê³ , Pod ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì€ ê²ƒìœ¼ë¡œ ì¸ì‹ë˜ë©´ endpoint ì—ì„œ ì œê±°ëœë‹¤.
  * `ReadinessProbe` ê°€ ì‹¤íŒ¨í•˜ë”ë¼ë„ Pod ëŠ” ë‹¤ì‹œ ì‹œì‘ë˜ì§€ ì•ŠëŠ”ë‹¤.

---

## Kubernetes and the JVM

:::quote
[Kubernetes and the JVM](https://xebia.com/blog/kubernetes-and-the-jvm/) ì˜ ì¼ë¶€ ë‚´ìš©
:::

:::neutral
If the JVM runs out of memory, it may result in the application crashing or other unexpected behavior.
To avoid this, it's essential to set appropriate requests and limits for memory
:::


### Request, Limits and the JVM

* request / limit memory ë³´ë‹¤ ì‘ì€ `-Xmx` ë¥¼ ì„¤ì •í•œë‹¤.
* request / limit memory ëŠ” ë™ì¼í•˜ê²Œ ì„¤ì •í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤.
  * QoS Guaranteed ë¥¼ ì ìš©í•´ë¼.


### "Helpers" for configuring the Heap Size

* heap í¬ê¸°ë¥¼ ê³ ì •í•˜ì§€ ë§ê³ , `-XX: InitialRAMPercentage` / `-XX: MaxRAMPercentage` ë¡œ ì‚¬ìš© ê°€ëŠ¥í•œ ë©”ëª¨ë¦¬ì˜ ë°±ë¶„ìœ¨ë¡œ ì„¤ì •í•œë‹¤.
* kubernetes ì™€ ê°™ì´ Pod í™•ì¥, ë…¸ë“œ í™•ì¥ ë“± ê¸°íƒ€ ìš”ì¸ìœ¼ë¡œ ì¸í•´ ì‚¬ìš© ê°€ëŠ¥í•œ ë©”ëª¨ë¦¬ê°€ ë³€ë™ ë  ìˆ˜ ìˆëŠ” ë™ì  í™˜ê²½ì—ì„œëŠ” ì¤‘ìš”í•œ ì—­í• ì´ ë  ìˆ˜ ìˆë‹¤.
* request ì™€ limit ì„ ê°™ì´ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ kubernetes ì—ì„œ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì„ ê´€ë¦¬í•˜ê¸° ìœ„í•œ ì•ˆì •ì ì´ê³ , ê¶Œì¥ë˜ëŠ” ì ‘ê·¼ ë°©ë²•ì´ë‹¤.


:::note
request / limits + -XX: InitialRAMPercentage / -XX: MaxRAMPercentage
:::


### So, how could we find these kubernetes memory settings (request / limit) ?

* Non heap memory ë„ ê³ ë ¤í•´ë¼.
* RAM ê¸°ë°˜ íŒŒì¼ ì‹œìŠ¤í…œë„ ì˜í–¥ì„ ë¯¸ì¹  ìˆ˜ ìˆë‹¤.
* -Xmx í™ì´ ì•„ë‹Œ ë©”ëª¨ë¦¬ê°€ ì†Œì§„ë˜ì–´ OutOfMemoryError ê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.
* Metaspace Memory ëŠ” -XX:MaxMetaspaceSize ë¡œ êµ¬ì„±ê°€ëŠ¥í•˜ê³ , ê²½í—˜ì ì¸ ê·œì¹™ì€ ë©”ëª¨ë¦¬ë³´ë‹¤ 16ë°° ë‚®ì€ ê°’ìœ¼ë¡œ ì œí•œ í•˜ëŠ” ê²ƒì´ë‹¤.

```shell
JVM ì— ì‚¬ìš© ê°€ëŠ¥í•œ ë©”ëª¨ë¦¬ê°€ 4GB ì¼ ë•Œ = XX:MaxMetaspaceSize=256M
```

### Garbage Collection

* ê°€ë¹„ì§€ ìˆ˜ì§‘ì˜ ë¹ˆë„ì™€ ì‹œê°„ì€ JVM Application ì„±ëŠ¥ê³¼ ì•ˆì •ì„±ì— í° ì˜í–¥ì„ ë¯¸ì¹  ìˆ˜ ìˆë‹¤.

```shell
-XX:+UseG1GC
-XX:MaxGCPauseMillis
```

---

## Some best practices when running JVM on the Kubernetes cluster

:::quote
[Some best practices when running JVM on the Kubernetes cluster](https://softwaremill.com/jvm-and-kubernetes-walk-into-a-bar/) ì— ëŒ€í•œ ìš”ì•½
:::

1. request / limit ì„¤ì •ì„ í•´ë¼.
2. request / limit ê°’ì„ ë™ì¼í•œ ê°’ìœ¼ë¡œ ì„¤ì •í•´ë¼.
3. XX: ActiveProcessorCount í”Œë˜ê·¸ë¥¼ ì„¤ì •í•˜ì—¬ ì‚¬ìš© ê°€ëŠ¥í•œ ì½”ì–´ ìˆ˜ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì„¤ì •í•´ë¼.
4. XX: MaxRAMPercentage ìµœëŒ€ í™ í¬ê¸° ê°’ì„ 60% ì •ë„ë¡œ ë§ì¶”ì–´ë¼.
5. UseContainerSupport ë¥¼ ë¹„í™œì„±í™”í•´ë¼.

:::note
UseContainerSupport ë¥¼ ë¹„í™œì„±í™”í•˜ë©´ JVM ì´ Container ê°€ ì‹¤í–‰ì¤‘ì¸ host ì¦‰, worker node ì˜ ë¦¬ì†ŒìŠ¤ ì •ë³´ë¥¼ ë°”ë¼ë³¸ë‹¤.
:::

---

## alibaba cloud - Best practices for jvm heap size configuration

:::quote
[alibaba cloud - Best practices for jvm heap size configuration](https://www.alibabacloud.com/help/en/sae/use-cases/best-practices-for-jvm-heap-size-configuration) ì— ëŒ€í•œ ë‚´ìš©
:::

### Use the -Xms and -Xms options to control heap size

#### ê¶Œì¥ë˜ëŠ” JVM heap size

|Memory|Heap Size|
|--|--|
|1 GB|600 MB|
|2 GB|1,434 MB|
|4 GB|2,867 MB|
|8 GB|5,734 MB|


```shell
ex) 4GB ì¼ ë•Œ, MaxRAMPercentage=70.0 ìœ¼ë¡œ ì„¤ì •í•˜ë©´ JVM ì€ ìµœëŒ€ 2.8GB í™ ë©”ëª¨ë¦¬ë¥¼ í• ë‹¹
```

---

## CloudBees - Java Heap settings Best Practice

:::quote
[CloudBees - Java Heap settings Best Practice](https://docs.cloudbees.com/docs/cloudbees-ci-kb/latest/best-practices/jvm-memory-settings-best-practice) ì— ëŒ€í•œ ë‚´ìš©
:::

### Encure container memory limits / requests are equal and use -XX:InitialRAMPercentage / -XX:MaxRAMPercentage

* -Xmx, -Xms ëŒ€ì‹  -XX:InitialRAMPercentage / -XX: MaxRAMPercentage ì„ ì‚¬ìš©í•´ë¼.
* VM í™ / ì»¨í…Œì´ë„ˆ ë©”ëª¨ë¦¬ ë¹„ìœ¨ì€ 0.5 ì€ ë¶ˆì•ˆì •í•œ ê²ƒìœ¼ë¡œ ì•Œë ¤ì¡Œë‹¤.

---

## Azure - Kubernetes ìš© Java ì• í”Œë¦¬ì¼€ì´ì…˜ ì»¨í…Œì´ë„ˆí™” / ìë°” ë©”ëª¨ë¦¬ ê´€ë¦¬

:::quote
[Azure - Kubernetes ìš© Java ì• í”Œë¦¬ì¼€ì´ì…˜ ì»¨í…Œì´ë„ˆí™”](https://learn.microsoft.com/ko-kr/azure/developer/java/containers/overview)
[Azure - Kubernetes ìš© Java ì• í”Œë¦¬ì¼€ì´ì…˜ ë©”ëª¨ë¦¬](https://learn.microsoft.com/en-us/azure/spring-apps/concepts-for-java-memory-management)
:::


1. CPU / Memory request / limit ì„ ë™ì¼í•œ ê°’ì„ ì„¤ì •í•œë‹¤.
2. JVM ì‚¬ìš© ê°€ëŠ¥í•œ í”„ë¡œì„¸ì„œ ì´í•´
* Kubernetes CPU í• ë‹¹ëŸ‰ì€ í”„ë¡œì„¸ìŠ¤ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” CPU ìˆ˜ê°€ ì•„ë‹ˆë¼ í”„ë¡œì„¸ìŠ¤ì—ì„œ CPU ì— ì†Œìš”ë˜ëŠ” ì‹œê°„ê³¼ ê´€ë ¨ ìˆë‹¤.
* JVM ê³¼ ê°™ì€ ë‹¤ì¤‘ ìŠ¤ë ˆë“œ ëŸ°íƒ€ì„ì€ ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ ìˆëŠ” ì—¬ëŸ¬ í”„ë¡œì„¸ì„œë¥¼ ë™ì‹œì— ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.
* ì»¨í…Œì´ë„ˆ í•˜ë‚˜ì˜ CPU ì œí•œì´ ìˆë”ë¼ë„ JVM ì— ì‚¬ìš© ê°€ëŠ¥í•œ í”„ë¡œì„¸ìŠ¤ë¥¼ ì§€ì •í•  ìˆ˜ ìˆë‹¤.

```shell
-XX:ActiveProcessorCount=N
```

3. Default maximum heap size
* Azure Spring App ì€ ê¸°ë³¸ì ìœ¼ë¡œ heap memory size ê°€ 50~80% ìœ¼ë¡œ ì„¤ì •ëœë‹¤.

```
1GB ë³´ë‹¤ ì‘ìœ¼ë©´ 50%
1GB < app memory < 2GB = 60%
2GB < app memory < 3GB = 70%
3GB < app memory = 80%
```

---

## Pretius - JVM Kubernetes: Optimizing Kubernetes for Java Developers

:::quote
[Pretius - JVM Kubernetes: Optimizing Kubernetes for Java Developers](https://pretius.com/blog/jvm-kubernetes/) ì— ëŒ€í•œ ë‚´ìš©
:::

### JVM Kubernetes - memory limit and usage

:::neutral
"The default limits are very small, so you should always set the memory limits in your java application when running it in a container"
ê¸°ë³¸ ì„¤ì •ì€ ë‚®ìœ¼ë‹ˆ í•­ìƒ memory limit ì„ ì„¤ì •í•´ë¼.
:::

#### ë©”ëª¨ë¦¬ í• ë‹¹ëŸ‰ ê³„ì‚° (Calculating memory usage)

1. SYSTEM AND CLASS DATA
* ì‹œìŠ¤í…œ ë° í´ë˜ìŠ¤ ë°ì´í„°ëŠ” ìˆ˜ì‹­ MBë§Œ ì‚¬ìš©í•  ê°€ëŠ¥ì„±ì´ ë†’ìœ¼ë‹ˆ 50MB ë¡œ ì„¤ì •í•˜ëŠ” ê²Œ ì¢‹ë‹¤.

2. THREADS
* ì‚¬ìš©ì¤‘ì¸ Thread ìˆ˜ì— ìì²´ ì•ˆì „ ê³„ìˆ˜ë¥¼ ê³±í•˜ì—¬ í•„ìš”í•œ ë©”ëª¨ë¦¬ë¥¼ ì¶”ì •í•´ë¼.

3. MAXIMUM HEAP SIZE
* ì»¨í…Œì´ë„ˆì˜ ì•½ 75~80% ë¡œ ì´ˆê¸° í™ ì‚¬ì´ì¦ˆë¥¼ ì§€ì •í•´ë¼.

4. JVM Kubernetes - CPU usage

:::neutral
"if your container CPU limits is too low, your application will be extremely slow under heavy stress. Your SLA commitment on request handling time will likely be breached."
CPU limit ì´ ë„ˆë¬´ ë‚®ìœ¼ë©´, ì–´í”Œë¦¬ì¼€ì´ì…˜ ì†ë„ê°€ ëŠë ¤ì§ˆ ìˆ˜ ìˆë‹¤.
:::

5. Other impacts of Kubernetes CPU limits
* -XX: ActiveProcessorCount í”Œë˜ê·¸ë¥¼ ì‚¬ìš©í•˜ì—¬ Java CPU ìˆ˜ë¥¼ limit ~ 2ë°°ë¡œ ì„¤ì •í•œë‹¤.

:::note
ActiveProcessorCount í”Œë˜ê·¸ë¥¼ limit ~ 2ë°°ë¡œ ì„¤ì •í•˜ëŠ” ê²ƒì€ ì˜¤íˆë ¤ ì˜ëª»ëœ ì„¤ì •ì¼ ìˆ˜ë„ ìˆë‹¤.
ë³´í†µì€ request cpu = limit cpu = ActiveProcessorCount ë¥¼ ë™ì¼í•˜ê²Œ ê°€ì ¸ê°€ëŠ”ê²Œ ë§ë‹¤.
ì˜¤íˆë ¤, limit cpu ë³´ë‹¤ í¬ê²Œ ë˜ë©´ context switching ë¹„ìš©ì´ ë” ë“¤ì–´ì„œ ì˜¤ë²„í—¤ë“œê°€ ì‹¬í•´ì§„ë‹¤.
ë”°ë¼ì„œ, ì ì ˆí•œ ê°’ì€ í…ŒìŠ¤íŠ¸ë¥¼ í•´ë³´ê³  ê²°ì • í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤.
:::

6. Java ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ ì¤‘ìš”í•œ pool ì— ëŒ€í•´ ìŠ¤ë ˆë“œ ìˆ˜ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì„¤ì •í•œë‹¤.
7. Garbage collection
* ì¼ë°˜ì ì¸ 1GB memory, 2 CPU java ì–´í”Œë¦¬ì¼€ì´ì…˜ì—ëŠ” ë³‘ë ¬ GC ë¥¼ ì‚¬ìš©í•´ë¼.
* í™ì´ ì•½ 2~4GB ì¸ ê²½ìš° G1(JDK < 17) /Z GC(JDK +17) ë¡œ ì „í™˜í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤.


<br/>

## Summary

---


ìœ„ì˜ ë‚´ìš©ì„ ì•„ë˜ì™€ ê°™ì´ ì •ë¦¬ í•  ìˆ˜ ìˆì„ ê²ƒ ê°™ë‹¤.

1) ì´ˆê¸° í™ ì‚¬ì´ì¦ˆì™€ ìµœëŒ€ í™ ì‚¬ì´ì¦ˆë¥¼ ë™ì¼í•˜ê²Œ ë§ì¶˜ë‹¤.

```shell
ex) -Xms = -Xmx
```

2) Guaranteed QoS ì„¤ì •ì„ í•´ë¼.
* request / limit ë™ì¼í•˜ê²Œ ë§ì¶”ì§€ ì•ŠëŠ”ë‹¤ë©´, ë„ˆë¬´ ì°¨ì´ê°€ ë‚˜ì§€ ì•ŠëŠ” ê°’ìœ¼ë¡œ ì„¤ì •í•œë‹¤.
* request ëŠ” <BlueText>í‰ê·  ì‚¬ìš©ëŸ‰ + 10%, limit ì€ peek ì‚¬ìš©ëŸ‰ ì¤‘ ìµœëŒ€ ì‚¬ìš©ëŸ‰ </BlueText> ìœ¼ë¡œ ì„¤ì •í•œë‹¤.

3) -Xms, -Xmx ë³´ë‹¤ëŠ” MaxRAMPercentage ë¥¼ ì¤€ë‹¤. (ì¼ë¶€ëŠ” -Xms, -Xmx ì™€ ê°™ì´ ì„¸ë°€í•œ ê°’ì„ ì£¼ëŠ”ê²Œ ì¢‹ë‹¤ê³  ë§í•¨)
* MaxRAMPercentage ì˜µì…˜ì„ ì£¼ë©´ -xmx ì˜µì…˜ì€ ë¬´ì‹œëœë‹¤. (InitialRAMPercentage ì˜µì…˜ì„ ì£¼ë©´ -xms ëŠ” ë¬´ì‹œë¨)
* ìƒí™©ì— ë”°ë¼ ë‹¤ë¥´ê² ì§€ë§Œ, <BlueText>ëŒ€ë¶€ë¶„ 80.0 ~ 75.0 ì •ë„ë¡œ ê¶Œì¥</BlueText>í•˜ê³  ë§ì€ ë¦¬ì†ŒìŠ¤ë¥¼ ë‚­ë¹„í•˜ì§€ ì•ŠëŠ”ë‹¤.
* ë‹¨, JDK 17 ë¶€í„° ê°€ëŠ¥í•˜ë‹¤. (ì›ë˜ëŠ” JDK 8 ë¶€í„° ì§€ì›í–ˆì§€ë§Œ Container ë¡œ ì¸ì‹ì„ í•˜ì§€ ëª»í•˜ëŠ” ë²„ê·¸ê°€ ìˆì—ˆê³ , JDK 13 ì—ì„œ ìˆ˜ì •ë˜ì—ˆë‹¤.)

4) LivenessProbe ì™€ ReadinessProbe ë¥¼ ì„¤ì •í•´ì¤€ë‹¤.
5) ë³‘ë ¬ GC ë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜, í™ì„ ë§ì´ ì‚¬ìš©í•˜ë©´ G1/Z GC ë¥¼ ì‚¬ìš©í•´ë¼.



## ğŸ”‘ Key Summary !!


---

### ë©”ëª¨ë¦¬ ì „ëµ (Heap / Non-heap / ì—¬ìœ ë¶„)

:::note
Container ë©”ëª¨ë¦¬ ëŒ€ë¹„ Heap ë§Œ ìƒê°í•˜ì§€ ë§ê³ , <b>Non-heap + thread stack + native memory + buffer</b> ë“±ì„ í•©ì‚°í•´ì•¼í•œë‹¤.
ì´ˆê¸°ì—ëŠ” <b>Container ë©”ëª¨ë¦¬ì˜ 60 ~ 70% ìˆ˜ì¤€ì˜ heap ìƒí•œ</b> ì„ ë‘ê³  ë‚˜ë¨¸ì§€ë¥¼ ì—¬ìœ ë¶„ìœ¼ë¡œ í™•ë³´í•˜ëŠ” ë°©ì‹ì´ ì•ˆì „í•˜ë‹¤.
:::

```shell
Heap ~= ContainerMemory Ã— 0.60 ~ 0.75
Non-heap = Direct + Metaspace + CodeCache + (ThreadStack Ã— ThreadCount)
Headroom = ìµœì†Œ 20~25% ê¶Œì¥
```

#### 1) ê¶Œì¥ JVM í”Œë˜ê·¸
* í¼ì„¼íŠ¸ ê¸°ë°˜ì€ ì»¨í…Œì´ë„ˆ ë©”ëª¨ë¦¬ ë³€ë™ì— ìœ ì—°í•˜ë‹¤.

```shell
-XX:InitialRAMPercentage=60.0
-XX:MaxRAMPercentage=70.0
# í¼ì„¼íŠ¸ ê¸°ë°˜ì„ ì“°ë©´ -Xms/-XmxëŠ” ë¬´ì‹œë¨
```

#### 2) ê³ ì • Heap ì´ í•„ìš”í•œ ê²½ìš°
* ì„±ëŠ¥ ì˜ˆì¸¡ ê°€ëŠ¥ì„±ì´ ì¤‘ìš”í•˜ê±°ë‚˜, ì›Œí¬ë¡œë“œê°€ ì¼ì •í•˜ë‹¤ë©´ ê³ ì •ê°’ë„ ìœ íš¨í•˜ë‹¤.

```shell
-Xms=2048m -Xmx=2048m
# ê³ ì • í™ì„ ì“¸ ë•ŒëŠ” ì»¨í…Œì´ë„ˆ ë©”ëª¨ë¦¬ ëŒ€ë¹„ Headroom(â‰¥25%)ì„ ë°˜ë“œì‹œ í™•ë³´
```
:::tip
MetaspaceëŠ” ëŒ€ê°œ ìˆ˜ë°± MB ì„ ì—ì„œ ì¶©ë¶„í•˜ë‹¤. í•„ìš” ì‹œ `-XX:MaxMetaspaceSize=256m`ì²˜ëŸ¼ ìƒí•œì„ ì§€ì •í•´ ë©”ëª¨ë¦¬ ì˜ˆì¸¡ ê°€ëŠ¥ì„±ì„ ë†’ì¼ ìˆ˜ ìˆë‹¤.
:::

---

### CPU ì „ëµ (Request/Limit, ìŠ¤ë ˆë“œ ìˆ˜)

#### 1) QoS ì™€ Request / Limit ì œí•œ
* <BlueText>QoS Guaranteed</BlueText>ë¥¼ ìœ„í•´ <BlueText>request = limit</BlueText>ì„ ë™ì¼í•˜ê²Œ ë‘ëŠ” êµ¬ì„±ì´ ê°€ì¥ ì˜ˆì¸¡ ê°€ëŠ¥í•˜ë‹¤.
* ê·¸ë ‡ì§€ ì•Šë‹¤ë©´ requestëŠ” <BlueText>í‰ê·  + 10%</BlueText>, limitì€ <BlueText>í”¼í¬ ìƒí•œ</BlueText>ì— ê°€ê¹ê²Œ ì„¤ì •í•˜ë˜ **ì°¨ì´ë¥¼ ê³¼ë„í•˜ê²Œ ë²Œë¦¬ì§€ ì•Šê¸°**.

#### 2) CPU ê°œìˆ˜ ëª…ì‹œ
* ì»¨í…Œì´ë„ˆì˜ ì œí•œ ì½”ì–´ ìˆ˜ì™€ JVM ìŠ¤ë ˆë”©ì´ ì–´ê¸‹ë‚˜ë©´ ì›í•˜ëŠ” ì„±ëŠ¥ì´ ì•ˆ ë‚˜ì˜¬ ìˆ˜ ìˆë‹¤.

```shell
-XX:ActiveProcessorCount=<ì»¨í…Œì´ë„ˆ limit ì½”ì–´ ìˆ˜ ë˜ëŠ” ê·¸ì— ì¤€í•˜ëŠ” ê°’>
```

:::note
CPU limitì— ëŒ€í•´ì„œëŠ” â€œì„¤ì •í•˜ì§€ ë§ìâ€ vs â€œì„¤ì •í•˜ìâ€ ë…¼ìŸì´ ìˆìœ¼ë‚˜,
<b>ì—”í„°í”„ë¼ì´ì¦ˆ í™˜ê²½ì—ì„œëŠ” ì˜ˆì¸¡ ê°€ëŠ¥ì„±</b>ì„ ìœ„í•´ ì ì ˆí•œ limit ì‚¬ìš©ì´ ì‹¤ë¬´ì ìœ¼ë¡œ ë” ì•ˆì „í•œ ê²½ìš°ê°€ ë§ë‹¤.
:::

---

:::success
<b>Think..</b>
âœ” request / limit memory, cpu ì„¤ì •í•˜ì.
âœ” -xss(ThreadStackSize) ëŠ” default ê°’ì´ 1M ì´ë¯€ë¡œ êµ³ì´ ì„¤ì •í•˜ì§€ ë§ì.
âœ” QoS Guaranteed ì¸ Pod ë¥¼ ìƒì„±í•˜ì.
âœ” livenessProbe, readinessProbe ë¥¼ ì„¤ì •í•˜ì.
âœ” ActiveProcessorCount í”Œë˜ê·¸ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì„¤ì •í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤.
âœ” Xms = Xmx ë¥¼ ì‚¬ìš©í•œë‹¤ë©´ ë™ì¼í•œ ê°’ìœ¼ë¡œ ë§ì¶”ëŠ” ê²ƒì´ë‹¤.
â†’ ìµœëŒ€ í™ í¬ê¸°ë¥¼ ê³ ì •í•œë‹¤ë©´, Request / Limit memory ì˜ 60 ~ 80% ìœ¼ë¡œ ë§ì¶”ì.
âœ” (update) í™˜ê²½ì— ë”°ë¼ì„œ ë‹¤ë¥¼ ìˆ˜ ìˆì§€ë§Œ, QoS ë¥¼ ì ìš©í•˜ê³  í¼ì„¼í…Œì´ì§€ë¡œ ì¡°ì •í•˜ëŠ” ê²ƒì´ ë³´ë‹¤ ë” ì•ˆì •ì ìœ¼ë¡œ ìš´ì˜ì´ ë˜ëŠ” ê²ƒ ê°™ë‹¤..!
:::


---

## ğŸ“š Reference

* [JVM-in-Linux-containers-surviving-the-isolation](https://bell-sw.com/announcements/2020/10/28/JVM-in-Linux-containers-surviving-the-isolation/)
* [ì»¨í…Œì´ë„ˆì™€ JVMì˜ ë©”ëª¨ë¦¬ Limit ë° Request](https://gist.github.com/petrbouda/92d794370134fc9dda1fdc05473c7165)
* [JVM ì–´í”Œë¦¬ì¼€ì´ì…˜ ìš© Kubernetes ì˜ í™í¬ê¸°, ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ë° ë¦¬ì†ŒìŠ¤ ì œí•œ](https://akobor.me/posts/heap-size-and-resource-limits-in-kubernetes-for-jvm-applications)
* [ì»¨í…Œì´ë„ˆ í™˜ê²½ì—ì„œì˜ Java ì–´í”Œë¦¬ì¼€ì´ì…˜ì˜ ë¦¬ì†ŒìŠ¤ì™€ ë©”ëª¨ë¦¬ ì„¤ì •](https://findstar.pe.kr/2022/07/10/java-application-memory-size-on-container/)
* [Kubernetes ì»¨í…Œì´ë„ˆ í™˜ê²½ì—ì„œì˜ ì»´í“¨íŒ… ë¦¬ì†ŒìŠ¤ ì •ë³´ ë° ì œí•œ](https://effectivesquid.tistory.com/entry/Kubernetes-%EC%BB%A8%ED%85%8C%EC%9D%B4%EB%84%88-%ED%99%98%EA%B2%BD%EC%97%90%EC%84%9C%EC%9D%98-%EC%BB%B4%ED%93%A8%ED%8C%85-%EB%A6%AC%EC%86%8C%EC%8A%A4-%EC%A0%95%EB%B3%B4-%EB%B0%8F-%EC%A0%9C%ED%95%9C)
* [K8s í™˜ê²½ì—ì„œ ë” ë‚˜ì€ CPU ë° ë©”ëª¨ë¦¬ í™œìš©ì„ ìœ„í•´ JVM ì»¨í…Œì´ë„ˆë¥¼ ì¡°ì •í•©ë‹ˆë‹¤.](https://medium.com/@anurag2397/solving-javas-core-problems-around-memory-and-cpu-4d0c97748c43)
* [Kubernetes ì˜ JVM 14 ë©”ëª¨ë¦¬ì— ëŒ€í•œ ì‹¤ìš©ì ì¸ ê°€ì´ë“œ](https://focusedlabs.io/blog/the-no-nonsense-guide-to-jvm-14-memory-on-kubernetes-508m)
* [Kubernetes Resource Requestì™€ Limitì˜ ì´í•´](https://online.cocktailcloud.io/2019/04/30/kubernetes-resource-request%EC%99%80-limit%EC%9D%98-%EC%9D%B4%ED%95%B4/)
* [ì¿ ë²„ë„¤í‹°ìŠ¤ì—ì„œ ì‰½ê²Œ ì €ì§€ë¥´ëŠ” 10ê°€ì§€ ì‹¤ìˆ˜](https://coffeewhale.com/kubernetes/mistake/2020/11/29/mistake-10/)
