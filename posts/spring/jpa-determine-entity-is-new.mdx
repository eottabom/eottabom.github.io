---
title: "Spring Data JPA - ìƒˆë¡œìš´ Entity íŒë³„"
date: "2025-04-30"
tags: ["Spring", "JPA"]
summary: "How does Spring Data JPA Determine if an Entity is New?"
description: "Spring Data JPA ì—ì„œ Entity ê°€ ìƒˆë¡œìš´ ê²ƒì¸ì§€ íŒë‹¨í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ì„œ ì•Œì•„ë³´ì."
---

:::info
Spring Data JPA ë¥¼ ì‚¬ìš©í•˜ë‹¤ë³´ë©´ save() ë©”ì„œë“œ í˜¸ì¶œ ì‹œ ë‚´ë¶€ì ìœ¼ë¡œ persist() ë¥¼ í˜¸ì¶œí• ì§€, merge() ë¥¼ í˜¸ì¶œ í•  ì§€ ê²°ì •í•˜ê²Œ ëœë‹¤. <br/>
í•´ë‹¹ Entity ê°€ ìƒˆë¡œìš´ Entity ì¸ì§€ ì—¬ë¶€ì— ë”°ë¼ ê²°ì •ë˜ëŠ”ë°, Spring Data JPA ëŠ” Entity ê°€ ìƒˆë¡œìš´ì§€ ì–´ë–»ê²Œ íŒë‹¨í•˜ëŠ”ì§€ ì•Œì•„ë³´ì.
:::

---

### ì‹ ê·œ Entity íŒë‹¨ ë°©ì‹

Spring Data JPA ëŠ” ë‚´ë¶€ì ìœ¼ë¡œ `JpaEntityInformation` ì˜ `isNew(T entity)` ë©”ì„œë“œë¥¼ í˜¸ì¶œí•´ì„œ íŒë‹¨í•œë‹¤.

```java
@Override
public boolean isNew(T entity) {
    if (versionAttribute.isEmpty()
        || versionAttribute.map(Attribute::getJavaType).map(Class::isPrimitive).orElse(false)) {
        return super.isNew(entity);
    }
    BeanWrapper wrapper = new DirectFieldAccessFallbackBeanWrapper(entity);
    return versionAttribute.map(it -> wrapper.getPropertyValue(it.getName()) == null).orElse(true);
}
```

* `@Version` í•„ë“œê°€ ìˆë‹¤ë©´ â†’ í•´ë‹¹ ë²„ì „ í•„ë“œ ê°’ì´ null ì¸ì§€ ì—¬ë¶€ë¡œ íŒë‹¨
* `@Version` í•„ë“œê°€ ì—†ë‹¤ë©´ â†’ `@Id` í•„ë“œê°€ null ì´ê±°ë‚˜, primitive íƒ€ì…ì¼ ê²½ìš°, 0ì¸ì§€ ì—¬ë¶€ë¡œ íŒë‹¨

:::note
ì¦‰, ID ê°€ null ì´ë©´ **ì‹ ê·œ Entity ë¡œ ê°„ì£¼**í•˜ì—¬ **persist()** ê°€ í˜¸ì¶œëœë‹¤.
:::

---

### ì§ì ‘ ID ë¥¼ ì§€ì •í•œ ê²½ìš°ì˜ ë™ì‘

IDë¥¼ ì§ì ‘ ì§€ì •í•˜ê³  `save()` ë¥¼ í˜¸ì¶œí•˜ë©´, JPA ëŠ” í•´ë‹¹ Entity ê°€ ê¸°ì¡´ì— ì¡´ì¬í•œë‹¤ê³  íŒë‹¨í•˜ì—¬ merge()ë¥¼ ìˆ˜í–‰í•œë‹¤. <br />
ì´ë•Œ ì‹¤ì œ Database ì— í•´ë‹¹ IDê°€ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´, <BlueText> SELECT ì¿¼ë¦¬ëŠ” 0ê±´ì„ ë°˜í™˜í•˜ê³  </BlueText> <br />
JPA ëŠ” ë³‘í•©ìš© ì—”í‹°í‹°ë¥¼ ìƒˆë¡œ ìƒì„±í•˜ì—¬ INSERT ë¥¼ ì‹œë„í•˜ê±°ë‚˜, ì œì•½ ì¡°ê±´ ìœ„ë°˜ìœ¼ë¡œ ì˜ˆì™¸ê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤. <br />
<RedText> ê²°êµ­, ì‹ ê·œ Entity ì„ì—ë„ JPA ëŠ” ê¸°ì¡´ ë°ì´í„°ì²˜ëŸ¼ ì¸ì‹í•˜ê²Œ ë˜ì–´, ì˜ë„ì¹˜ ì•Šì€ UPDATE ë˜ëŠ” INSERT ì‹¤íŒ¨ë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆë‹¤ </RedText>


:::note
**merge** ëŠ” **UPDATE** ë¿ë§Œ ì•„ë‹ˆë¼, **INSERT** ë„ ê°€ëŠ¥í•˜ì§€ë§Œ, <br />
ì§ì ‘ ID ê°€ ì§€ì •ëœ ì‹ ê·œ ì—”í‹°í‹°ì—ëŠ” ë§¤ìš° ìœ„í—˜í•˜ë‹¤.
:::

ì´ë¥¼ í•´ê²° í•˜ê¸° ìœ„í•œ ë°©ë²•ìœ¼ë¡œëŠ” `Persistable<T>` ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ë©´ ëœë‹¤.

```java
// User.class

@Entity
@Table(name = "users")
@EntityListeners(UserEntityListener.class)
public class User implements Persistable<String> {

	@Id
	private String id;

	private String name;

	private boolean isNew = true;

	protected User() {

	}

	public User(String id, String name) {
		this.id = id;
		this.name = name;
	}

	@Override
	public String getId() {
		return this.id;
	}

	public void setId(String id) {
		this.id = id;
	}

	public String getName() {
		return this.name;
	}

	@Override
	public boolean isNew() {
		return this.isNew;
	}

	public void setIsNew(boolean isNew) {
		this.isNew = isNew;
	}

}

// UserEntityListener.class

public class UserEntityListener {
	@PostPersist
	@PostLoad
	public void setNotNew(User user) {
		System.out.println("@PostPersist/@PostLoad called");
		user.setIsNew(false);
	}

}
```

---

### persist() vs merge()

|êµ¬ë¶„|persist()|merge()|
|--|--|--|
|ë™ì‘|ìƒˆë¡œìš´ Entity ë¥¼ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ë“±ë¡|ì¤€ì˜ì† ê°ì²´ë¥¼ ë³‘í•©í•˜ì—¬ ê´€ë¦¬|
|SELECT ì¿¼ë¦¬|âŒ|âœ… ë¨¼ì € ì¡°íšŒ í›„ merge|
|ID í•„ìš” ì—¬ë¶€|âŒ|âœ…|
|ì„±ëŠ¥|ë¹ ë¦„ (ì§ì ‘ INSERT)|ëŠë¦´ìˆ˜ ìˆë‹¤ (SELECT + UPDATE)|

:::note
ì‹ ê·œ ê°ì²´ë¥¼ merge() ë¡œ ì²˜ë¦¬í•˜ë©´ ë¶ˆí•„ìš”í•œ SELECT ì¿¼ë¦¬ê°€ ë°œìƒí•˜ê³  ì„±ëŠ¥ ì €í•˜ ê°€ëŠ¥ì„±ì´ ì¡´ì¬í•˜ê²Œ ëœë‹¤.
:::

---

### ì‹ ê·œ Entity íŒë‹¨ì´ ì¤‘ìš”í•œ ì´ìœ ëŠ” ë¬´ì—‡ì¼ê¹Œ?

Spring Data JPA ì˜ `SimpleJpaRepository` ëŠ” `save()` ì—ì„œ ë‹¤ìŒê³¼ ê°™ì´ ë™ì‘í•œë‹¤.

```java
@Transactional
public <S extends T> S save(S entity) {
    if (entityInformation.isNew(entity)) {
        entityManager.persist(entity); // INSERT
        return entity;
    } else {
        return entityManager.merge(entity); // SELECT â†’ UPDATE, ì¡´ì¬í•˜ë©´ UPDATE ì—†ìœ¼ë©´ INSERT ê°€ëŠ¥ì„± ìˆìŒ
    }
}
```

ID ë¥¼ ì§ì ‘ ì„¤ì •í–ˆì§€ë§Œ, `isNew()` ëŠ” false ê°€ ë˜ì–´, `merge()` ë¥¼ í˜¸ì¶œí•˜ê²Œ ë˜ê³ , <br />
Database ì—ëŠ” í•´ë‹¹ ID ê°€ ì¡´ì¬í•˜ì§€ ì•Šì§€ë§Œ, ì‹ ê·œ Entity ì„ì—ë„ ë¶ˆêµ¬í•˜ê³ , `SELECT` í›„ `UPDATE` ë¥¼ í•˜ê²Œ ë˜ì–´ (ì´ ë•Œ, database ì¡°íšŒ) ì‹¤íŒ¨ ë˜ëŠ” ë°ì´í„° ë¬´ê²°ì„± ì˜¤ë¥˜ê°€ ë°œìƒí•  ìˆ˜ ìˆê³ , ë¹„íš¨ìœ¨ì ì´ë‹¤.


:::note
ì •í™•í•œ isNew() ì œì–´ëŠ” ì„±ëŠ¥, ì •í•©ì„±, ì¿¼ë¦¬ íš¨ìœ¨ì„± ì¸¡ë©´ì—ì„œ ë§¤ìš° ì¤‘ìš”í•˜ë‹¤.
:::

---

### ìš”ì•½

|ìƒí™©| ì²˜ë¦¬ë°©ì‹                                     |
|--|------------------------------------------|
|ID ì—†ê±°ë‚˜ null â†’ ì‹ ê·œ Entity | persist()                                |
|IDê°€ ì¡´ì¬í•˜ì§€ë§Œ ì‹¤ì œ DB ì—ëŠ” ì—†ìŒ | merge() í˜¸ì¶œ â†’ ì‹¤íŒ¨ ê°€ëŠ¥ì„± / ë¹„íš¨ìœ¨                |
|ID ë¥¼ ì§ì ‘ ì„¤ì •í•œ ì‹ ê·œ Entity| Persistable&#60;T&#62; + isNew() ë¡œ ëª…ì‹œ í•„ìš” |


:::tip
<a href="https://github.com/eottabom/let-me-code/tree/main/src/main/java/com/eottabom/letmecode/example/_01_jpa_entity">ì˜ˆì œ ì½”ë“œ ë³´ëŸ¬ê°€ê¸° (í´ë¦­)</a>
:::

<br/><br/>

---

:::success
<b>ì •ë¦¬</b>
Spring Data JPA ëŠ” ë‚´ë¶€ì ìœ¼ë¡œ isNew() ë¥¼ í†µí•´ì„œ ì‹ ê·œ Entity ì—¬ë¶€ë¥¼ íŒë‹¨í•œë‹¤.
ID ëŠ” ì¡´ì¬í•˜ì§€ë§Œ ì‹¤ì œ DB ì— ì—†ëŠ” ê²½ìš° SELECT + UPDATE í›„ merge ë¥¼ í•˜ë¯€ë¡œ ì •í•©ì„±ì´ ë–¨ì–´ì§ˆ ìˆ˜ ìˆê³ , ë¹„íš¨ìœ¨ì ì´ë‹¤.
ID ë¥¼ ì§ì ‘ ì„¤ì •í–ˆì„ ê²½ìš°ëŠ” Persistable + isNew() ë¡œ ëª…ì‹œí•˜ëŠ” ê²ƒì´ í•„ìš”í•˜ë‹¤.
:::


---

### ğŸ“š Reference

* [Spring Docs - JpaEntityInformation](https://docs.spring.io/spring-data/jpa/docs/current/api/org/springframework/data/jpa/repository/support/JpaEntityInformation.html)
* [Spring Docs - entity-persistence](https://docs.spring.io/spring-data/jpa/reference/jpa/entity-persistence.html)

<br/><br/>
