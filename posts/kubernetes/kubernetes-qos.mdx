---
title: "Pod QoS, Quality of Service Classes"
date: "2024-05-27"
tags: ["kubernetes"]
summary: "Pod Qos, Quality of Service Classes"
description: "Pod Quality of Service Classes ì— ëŒ€í•´ì„œ ì•Œì•„ë³´ì"
---

:::info
kubernetes ì—ì„œëŠ” Pod ì— ëŒ€í•œ QoS(Quality of Service) í´ë˜ìŠ¤ë¥¼ ì œê³µí•˜ê³  ìˆê³ , QoS ì— ëŒ€í•´ì„œ ê°„ëµí•˜ê²Œ ì •ë¦¬
:::

---

## Pod ì˜ QoS í´ë˜ìŠ¤ ë¶„ë¥˜

QoS ëŠ” Resource Requests ë¦¬ì†ŒìŠ¤ ìƒí•œì„ ì •í•˜ëŠ” **Resource Limits** ì¡°ê±´ì„ ë°”íƒ•ìœ¼ë¡œ ìš°ì„ ìˆœìœ„ê°€ ì •í•´ì§„ë‹¤.

|êµ¬ë¶„| ë‚´ìš©                                                                                      | Case                                     |
|--|-----------------------------------------------------------------------------------------|------------------------------------------|
|BestEffort| ìš°ì„ ìˆœìœ„ê°€ ê°€ì¥ ë‚®ê³  <br/> ë©”ëª¨ë¦¬ê°€ ë¶€ì¡±í•œ ê²½ìš° kill                                                       | Container ì˜ Request ì™€ Limit ì´ ì„¤ì •ë˜ì§€ ì•Šì€ ê²½ìš° |
|Burstable| ìµœì†Œí•œì˜ ë¦¬ì†ŒìŠ¤ë¥¼ ë³´ì¥ ë°›ìœ¼ë©°, <br/> í•„ìš”í•œ ê²½ìš° ë” ë§ì€ ë¦¬ì†ŒìŠ¤ë¥¼ í• ë‹¹ ë°›ìŒ <br/> ë©”ëª¨ë¦¬ê°€ ë¶€ì¡±í•œ ê²½ìš° ë‹¤ë¥¸ BestEffort ê°€ ì—†ë‹¤ë©´ kill | Container ì˜ Request ì™€ Limit ì´ ì¼ì¹˜í•˜ì§€ ì•ŠëŠ” ê²½ìš° <br/> Container ì˜ Request ì™€ Limit ì¤‘ í•˜ë‚˜ë§Œ ì„¤ì •ëœ ê²½ìš° <br/>  Request ì™€ Limit ì´ ì„¤ì •ë˜ì§€ ì•Šì€ Container ê°€ ìˆëŠ” ê²½ìš°|
|Guaranteed| <BlueText> **ìš°ì„ ìˆœìœ„ê°€ ë†’ê³ ** </BlueText>, <br/> Limits ë¥¼ ë„˜ì§€ ì•ŠëŠ” í•œ kill ë˜ì§€ ì•ŠìŒì´ ë³´ì¥    | ëª¨ë“  Container ì˜ Request ì™€ Limit ì´ ì„¤ì • ë˜ì–´ ìˆê³ , <br/> ê°ê° Container ì˜ Request ì™€ Limit ì´ ì¼ì¹˜í•˜ëŠ” ê²½ìš°|

<div style={{ textAlign: 'center' }}>
    <img src="/img/post/kubernetes/qos/qos.png" alt="qos"  style={{ display: 'inline-block' }} />
</div>

---

## Case

| CPU              | Memory           |Qos Classes|
|------------------|------------------|----------|
| -                | -                |BestEffort|
| -                | Reqeust < Limits |Burstable|
| -                | Reqeust = Limits |Burstable|
| Reqeust < Limits | -                |Burstable|
| Reqeust < Limits | Reqeust < Limits |Burstable|
| Reqeust < Limits | Reqeust = Limits |Burstable|
| Reqeust = Limits | Reqeust < Limits |Burstable|
| Reqeust = Limits | Reqeust = Limits |Guaranteed|


:::note
ë§Œì¼ side-car ë¥¼ ì‚¬ìš©í•œë‹¤ë©´, ëª¨ë“  side-car ì˜ CPU / Memory Request = Limit ë¥¼ ë§ì¶°ì•¼ Guaranteed ê°€ ëœë‹¤ëŠ” ê²ƒì´ë‹¤.
:::

---

## QoS ì˜ˆì‹œ

### 1) BestEffort

```yaml
...
    spec:
      containers:
        - name: app
          image: busybox
        - name: fluentd
          image: fluent/fluentd
...
```

### 2) Burstable

```yaml
...
spec:
  containers:
    - name: app
      image: busybox
      resources:
        request:
          memory: "128Mi" ### request, limit ì˜ memory ë¥¼ ë‹¤ë¥´ê²Œ ì„¤ì •
          cpu: "500m"
        limit:
          memory: "256Mi"
          cpu: "500m"
    - name: fluentd
      image: fluent/fluentd
      resources:
        request:
          memory: "128Mi"
          cpu: "500m"
        limit:
          memory: "128Mi"
          cpu: "500m"
...
```

```yaml
...
spec:
  containers:
    - name: app
      image: busybox
      resources:
        request:
          memory: "128Mi"
          cpu: "500m"
        limit:
          memory: "128Mi"
          cpu: "500m"
    - name: fluentd
      image: fluent/fluentd
      resources:
        request:
          memory: "128Mi"
          cpu: "200m" ### side-car ì˜ request, limit ì˜ cpu ë¥¼ ë‹¤ë¥´ê²Œ ì„¤ì •
        limit:
          memory: "128Mi"
          cpu: "500m"
...
```

### 3) Guaranteed

```yaml
...
spec:
  containers:
    - name: app
      image: busybox
      resources:
        request: ### request, limit memory, cpu ë™ì¼í•˜ê²Œ ì„¤ì •
          memory: "128Mi"
          cpu: "500m"
        limit:
          memory: "128Mi"
          cpu: "500m"
    - name: fluentd
      image: fluent/fluentd
      resources:
        request: ### request, limit memory, cpu ë™ì¼í•˜ê²Œ ì„¤ì •
          memory: "128Mi"
          cpu: "200m"
        limit:
          memory: "128Mi"
          cpu: "200m"
...
```

---

## ìš°ì„  ìˆœìœ„ ë§¤ì»¤ë‹ˆì¦˜

kubernetes ì—ì„œ ë¦¬ì†ŒìŠ¤ê°€ ë¶€ì¡±í•˜ë©´ QoS ì— ë”°ë¼ ì–´ë–¤ Pod ì˜ Container ì˜ Application ì„ Kill í• ì§€ ì¶”ì •í•œë‹¤.

:::note
BestEffort < Burstable < Guaranteed
:::

Guaranteed ëŠ” node ì—ì„œ ë©”ëª¨ë¦¬ë¥¼ í•„ìš”ë¡œ í•˜ëŠ” ê²½ìš°ì—ë§Œ kill ëœë‹¤.

:::note
kubelet ì€ eviction ì œê±° ìˆœì„œë¥¼ ê²°ì •í•˜ê¸° ìœ„í•´ì„œ Pod ì˜ QoS í´ë˜ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.
QoS í´ë˜ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ë©”ëª¨ë¦¬ì™€ ê°™ì€ ë¦¬ì†ŒìŠ¤ë¥¼ íšŒìˆ˜í•  ë•Œ ê°€ì¥ ê°€ëŠ¥ì„±ì´ ë†’ì€ Pod ë¥¼ ì¶”ì •í•œë‹¤.
:::

---

### Pod Qos ì— ë”°ë¥¸ oom_score_adj ê°’

|Pod Qos| oom_score_adj                                                                     |
|--|-----------------------------------------------------------------------------------|
|Guaranteed| -997 (ê³ ì •)                                                                         |
|Burstable| min(max(2, 1000 - (1000 * memoryRequestBytes) / machineMemoryCapacityBytes), 999) |
|BestEffort| 1000 (ê³ ì •)                                                                         |

`Guaranteed` ëŠ” -997 ì˜ ê³ ì • ê°’ì„ ê°€ì§€ê³  ìˆê³ ,
`BestEffort` ëŠ” 1000 ì˜ ê³ ì • ê°’ì„ ê°€ì§€ê³  ìˆë‹¤.
`Burstable` ëŠ” Pod ì˜ Manifest ì— ëª…ì‹œëœ Container ì˜ Memory Request ê°’ì´ **ë†’ì„ìˆ˜ë¡ ë‚®ì€ ê°’**ì„ ê°€ì§€ë©°, 2~999 ì‚¬ì´ì˜ ê°’ì„ ê°€ì§„ë‹¤.

Container ì˜ Process ì˜ oom_score ê°’ê³¼ kubernetes ê°€ ì„¤ì •í•œ oom_score_adj ê°’ì˜ í•©ì´ ë†’ì„ ìˆ˜ë¡
OOM Killer ì— ì˜í•´ì„œ ì„ íƒë  í™•ë¥ ì´ ë†’ì•„ì§„ë‹¤.
í•©ì´ 0 ì´ë©´ OOM Killer ì„ íƒ ëŒ€ìƒì—ì„œ ì œì™¸ë˜ë©°, í•©ì´ 1000ì„ ë„˜ì–´ê°€ë©´ OOM Killer ì— ì˜í•´ì„œ ë°˜ë“œì‹œ ì œê±°ëœë‹¤.

:::success
<b>ìš”ì•½</b>
âœ” Guaranteed Qos ë¥¼ ê°–ëŠ” Pod ì˜ Container ëŠ” OOM Killer ì— ì˜í•´ ê±°ì˜ ì„ íƒë˜ì§€ ì•ŠëŠ”ë‹¤.
âœ” BestEffort Qos ë¥¼ ê°–ëŠ” Pod ì˜ Container ëŠ” OOM Killer ì— ì˜í•´ ë°˜ë“œì‹œ ì„ íƒë˜ì–´ ì œê±°ëœë‹¤.
âœ” Burstable QoS ë¥¼ ê°–ëŠ” Pod ì˜ Container ëŠ” Memory ì‚¬ìš©ëŸ‰ì´ ì—†ì–´ë„ oom_score_adj ê°’ì´ 999 ê°€ ë˜ê¸° ë•Œë¬¸ì— ë†’ì€ í™•ë¥ ë¡œ OOM Killer ì— ì˜í•´ ì œê±°ë  í™•ë¥ ì´ ë†’ë‹¤.
âœ” Memory ì‚¬ìš©ëŸ‰ì´ ë†’ìœ¼ë©´ oom_score_adj ê°’ì´ ë‚®ë”ë¼ë„ oom_score ê°’ì´ ë†’ê¸° ë•Œë¬¸ì— ë†’ì€ í™•ë¥ ë¡œ OOM Killer ì— ì˜í•´ ì„ íƒë˜ì–´ ì œê±° ë  ìˆ˜ ìˆë‹¤.
:::

---

## ê°„ë‹¨í•œ ì˜ˆì‹œ

Pod1, Pod2, Pod3 ì´ ê°ê° Guaranteed, Burstable, BestEffort QoS ë¶„ë¥˜ê°€ ë˜ì–´ ìˆë‹¤ê³  ê°€ì •

| Pod  |Qos|
|------|--|
| Pod1 |Guaranteed|
| Pod2 |Burstable|
| Pod3 |BestEffort|

---

### Q. Pod1 ì´ ë¦¬ì†ŒìŠ¤ë¥¼ ì¶”ê°€ë¡œ ìš”ì²­í•˜ê³  node ì—ëŠ” ì—¬ìœ  ë¦¬ì†ŒìŠ¤ê°€ ì—†ëŠ” ìƒíƒœì¼ ë•ŒëŠ”?

<BlueText><span style={{ fontSize: '1.5rem', }}>A. </span></BlueText> Pod2 ì™€ Pod3 ì´ ê°™ì€ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì„ ì‚¬ìš©í•˜ê³  ìˆë‹¤ë©´, **BestEffort** ë¡œ QoS ë¶„ë¥˜ê°€ ë˜ì–´ ìˆëŠ” Pod3 ì„ ì£½ì´ê³ ,
Pod3 ì— ìˆëŠ” ë¦¬ì†ŒìŠ¤ë“¤ì„ Pod1 ì´ í•„ìš”í•œ ë§Œí¼ì˜ ë¦¬ì†ŒìŠ¤ë¥¼ í• ë‹¹í•˜ê³  node ì˜ ì—¬ìœ  ìì›ìœ¼ë¡œ íšŒìˆ˜í•˜ê²Œ ëœë‹¤.

:::warning
Pod2ì™€ Pod3ì´ ì‚¬ìš©í•˜ëŠ” ë©”ëª¨ë¦¬ì— ë”°ë¼ì„œ eviction ìˆœì„œê°€ ë°”ë€” ìˆ˜ ìˆë‹¤.
:::

---

### Q. Pod1, Pod2 ë§Œ ìš´ì˜ ì¤‘ì¼ë•Œ, Pod2 ê°€ í˜„ì¬ node ì˜ ì—¬ìœ ìì› ë³´ë‹¤ ë§ì€ ë¦¬ì†ŒìŠ¤ë¥¼ ìš”ì²­í•˜ê²Œ ëœ ê²½ìš°ëŠ”?

<BlueText><span style={{ fontSize: '1.5rem', }}>A. </span></BlueText> Pod2 ì˜ QoS ëŠ” **Burstable** ì´ê³ , Pod1 ì˜ QoS ëŠ” **Guaranteed** ì´ë¯€ë¡œ,
Pod2 ì˜ ìš°ì„ ìˆœìœ„ê°€ ë‚®ê¸° ë•Œë¬¸ì— ì¶”ê°€ì ì¸ ë¦¬ì†ŒìŠ¤ë¥¼ í• ë‹¹ ë°›ì§€ ëª»í•˜ê³  ì£½ê²Œ ë  ê°€ëŠ¥ì„±ì´ ë†’ë‹¤.

---

### Q. ë§Œì¼ ê°™ì€ QoS ì¼ ë•ŒëŠ”?

<BlueText><span style={{ fontSize: '1.5rem', }}>A. </span></BlueText> OutOfMemory Score ì— ë”°ë¼ ì–´ë–¤ Pod ë¥¼ Kill í• ì§€ ë¹„êµí•˜ì—¬ ì •í•œë‹¤.


---

## ğŸ“š Reference

* [Configure Quality of Service for Pods](https://kubernetes.io/docs/tasks/configure-pod-container/quality-service-pod/)
* [k8s íŒŒë“œì˜ ìš°ì„ ìˆœìœ„(Pod QoS, Quality of Service)](https://kimjingo.tistory.com/139)
* [Node-pressure Eviction](https://kubernetes.io/docs/concepts/scheduling-eviction/node-pressure-eviction/#node-oom-behavior)
* [Another OOM killer rewrite](https://lwn.net/Articles/391222/)



